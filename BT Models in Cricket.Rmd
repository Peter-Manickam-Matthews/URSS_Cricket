---
title: 'URSS: Bradley-Terry Models in Cricket'
author: "Peter Matthews"
date: "07/07/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
Write this bit up later. For now import tidyverse, fs to deal with files, and hyper2 to construct and optimise liklihood-functions, BradleyTerry2 for fitting basic Bradley-Terry models. 
```{r imports, collapse=TRUE, warning=FALSE}
library(tidyverse)
library(fs)
library(BradleyTerry2)
library(hyper2)
```

## Data

The ODI Matches folder - downloaded from <https://cricsheet.org/downloads/> - contains a csv file for each ODI played after March 2004 (Matches from 1st Jan 2018 are in "ODIs since 2018"). In each row in each file corresponds to 1 ball in the match, with the following attributes - match_id, season, start_date, venue, innings, ball, batting_team, bowling_team, striker, non_striker, bowler, runs_off_bat, extras, wides, noballs, byes, legbyes, penalty, wicket_type, player_dismissed, other_wicket_type, other_player_dismissed. 
We only care about matches since 2018 and are interested in striker, bowler, runs_off_bat, wicket_type. For now ignore extras and run outs but I'll keep innings and ball numbers to add as covariates later.


```{r data}
files <- fs::dir_ls("ODIs since 2018")
files <- map(files,
             function(path){
               read.csv(path, 
                        colClasses = c("numeric", "character", "Date", "character",	"numeric",	"numeric",	"character",	"character",	"character",	"character",	"character",	"integer",	"integer",	"integer",	"integer",	"integer",	"integer",	"integer",	"character",	"character",	"character",	"character"
)) ## have to specify classes so that R can correctly bind rows
               })
full_data <- bind_rows(files)
model_data <- filter(full_data, extras == 0, wicket_type != "run out") ## Ignore balls with runs not credited to batsman and wickets not credited to bowler
model_data$wicket <- model_data$wicket_type != ""

model_data <- model_data %>% select(striker, bowler, runs_off_bat, wicket, innings, ball) ##keeping innings and ball numbers as covariates later, when that happens will have to process them more here

head(model_data)
```

## Data Cleaning for First Model

Relatively easy thing to get started, for now we can fit the wickets model as a simple Bradley-Terry with an order effect on bowlers (reflecting how hard it is to take a wicket, compared to just surviving one ball)

Here is a function to put the model data into the format that models can be fitted with. For the wicket model BradleyTerry2 "prefers" data to be summarised for each pair of batsman and bowler.

```{r data_count}
DataToBinomial <- function(model_data){
  binom <- model_data %>% 
    group_by(bowler, striker) %>% 
    summarise(wickets = sum(wicket), survivals = sum(!wicket))
  
  ## after this point could be reused when including covariates (need to change first part to group table differently)
  binom$bowler <- paste(binom$bowler, "Bowl")
  binom$striker <- paste(binom$striker, "Bat")
  binom$bowl <- factor(binom$bowler, levels = unique(c(binom$bowler, binom$striker, "Average")))
  binom$bat <- factor(binom$striker, levels = unique(c(binom$bowler, binom$striker, "Average")))
  binom$bowl <- data.frame(player = binom$bowl, batting = 0)
  binom$bat <- data.frame(player = binom$bat, batting = 1)
  binom <- binom %>% select(bowl, bat, wickets, survivals)
  return(binom)
}

BTdata <- DataToBinomial(model_data)

```

Function to add a prior, with each player having bowled 38 balls to and faced 38 balls from "Average" player, with 1 wicket and 37 survivals (average not out balls per wicket across the dataset). Adding this helps a lot with the stability of the first wicket model at least

```{r priors}
add_prior <- function(model_data, wickets = 1, survivals = 37){
  ## There is gonna be a much nicer purr implementation for doing it but this works for now
  bowl.prior = model_data[1: length(unique(model_data$bowl$player)),] ## creates a dataframe the right size to add stuff to.
  bat.prior = model_data[1: length(unique(model_data$bat$player)), ]
  
  bowl.prior$bowler = unique(model_data$bowl$player)
  bowl.prior$bowl$player = unique(model_data$bowl$player)
  bowl.prior$bowl$batting = 0
  bowl.prior$bat$player = factor("Average")
  bowl.prior$bat$batting = 1
  bowl.prior$wickets = wickets
  bowl.prior$survivals = survivals
  
  bat.prior$bat$player = unique(model_data$bat$player)
  bat.prior$bowl$player = factor("Average")
  bat.prior$bowl$batting = 0
  bat.prior$bowler = factor("Average")
  bat.prior$bat$batting = 1
  bat.prior$wickets = wickets
  bat.prior$survivals = survivals
  
  return(rbind(model_data, bowl.prior, bat.prior))
}

BTdata <- add_prior(BTdata)
```
## First Wicket-Based Model

The initial baby wicket model that just has an order effect for batting (otherwise it would be meaningless) and no other covariates. Can be done with BradleyTerry2 but will probably fit runs models with hyper2 or gnm. Takes about 3 mins to run on my laptop
```{r first_model}
FirstWickModel <- BTm(outcome = cbind(wickets, survivals), player1 = bowl, player2 = bat,
  data = BTdata, id = "player", formula = ~ player + batting, refcat = "Average")
```
Seems to give semi reasonable results, a lot of players who don't bowl or bat that much rise to the tip so prior probably needs to bbe strengthened a bit. Batting "advantage" of 3.967 implies that the average batsman gets out to the average bowler once every 53 balls, which is pretty high but within the realms of what you would expect. Based on the results pretty sure the "average" bowler (log-score = 0) of this model is comparitively worse than the true average bowler of the data. 
```{r results}
sort(FirstWickModel$coefficients, decreasing = T) ##need to figure out how to split into batting and bowling
```
How long would Joe Root survive against himself?
```{r Root}
batadvantage = 3.967145852
bowl = 0.629774970
bat = 0.550226006  ##had to manually look these up because R doesn't like indexing things with spaces, need to fix.

## 1 / Probability of getting out each ball
1 + exp(batadvantage + bat - bowl)
```